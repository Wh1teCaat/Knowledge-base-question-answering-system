<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <title>RAG Êô∫ËÉΩÈóÆÁ≠îÂä©Êâã</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      * {
        box-sizing: border-box;
      }
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, "Microsoft YaHei", sans-serif;
        background: #ffffff;
        display: flex;
        flex-direction: column;
        height: 100vh;
        margin: 0;
        overflow: hidden;
      }
      header {
        background: #2563eb;
        color: #fff;
        padding: 12px 20px;
        font-size: 18px;
        font-weight: 600;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
      }
      main {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 12px;
        position: relative;
      }
      main.empty {
        justify-content: center;
        align-items: center;
      }
      .greeting {
        text-align: center;
        color: #2563eb;
        font-size: 24px;
        font-weight: 500;
        margin-bottom: 40px;
        opacity: 0;
        animation: fadeIn 0.5s ease-in forwards;
      }
      .bubble {
        max-width: 75%;
        padding: 12px 16px;
        border-radius: 16px;
        line-height: 1.6;
        white-space: pre-wrap;
        animation: fadeIn 0.3s ease-in;
        word-wrap: break-word;
      }
      .user {
        align-self: flex-end;
        background: #2563eb;
        color: #fff;
        border-bottom-right-radius: 4px;
      }
      .bot {
        align-self: flex-start;
        background: #f3f4f6;
        color: #1f2937;
        border: 1px solid #e5e7eb;
        border-bottom-left-radius: 4px;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      footer {
        padding: 16px 20px;
        background: #fff;
        border-top: 1px solid #e5e7eb;
        display: flex;
        justify-content: center;
        align-items: center;
        flex-shrink: 0;
        transition: all 0.3s ease;
      }
      footer.centered {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        border-top: none;
        background: transparent;
      }
      .input-container {
        width: 100%;
        max-width: 800px;
        position: relative;
        transition: all 0.3s ease;
      }
      footer.centered .input-container {
        max-width: 600px;
      }
      input {
        width: 100%;
        padding: 16px 20px;
        border: 1px solid #d1d5db;
        border-radius: 24px;
        font-size: 16px;
        background: #ffffff;
        color: #1f2937;
        transition: all 0.3s ease;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }
      input:focus {
        outline: none;
        border-color: #2563eb;
        box-shadow: 0 2px 8px rgba(37, 99, 235, 0.2);
      }
      input::placeholder {
        color: #9ca3af;
      }
      button {
        display: none;
      }
      .input-wrapper {
        position: relative;
        width: 100%;
      }
    </style>
  </head>
  <body>
    <header>
      <div>üí¨ RAG Êô∫ËÉΩÈóÆÁ≠îÂä©Êâã ‚Äî ÂΩìÂâçÁî®Êà∑Ôºö{{ username or "Êú™ÁôªÂΩï" }}</div>
      <a
        href="{{ url_for('logout') }}"
        style="color: #fff; text-decoration: none; font-size: 14px"
        >ÈÄÄÂá∫ÁôªÂΩï</a
      >
    </header>

    <main id="chat" class="empty">
      <div class="greeting" id="greeting">‰Ω†Â•ΩÔºÅ</div>
    </main>

    <footer id="footer" class="centered">
      <div class="input-container">
        <div class="input-wrapper">
          <input
            id="query"
            type="text"
            placeholder="ËæìÂÖ•‰Ω†ÁöÑÈóÆÈ¢òÔºåÊåâ Enter ÂèëÈÄÅ..."
            autofocus
          />
        </div>
      </div>
      <button id="send" style="display: none">ÂèëÈÄÅ</button>
      <button id="clear" style="display: none">Ê∏ÖÁ©∫</button>
    </footer>

    <script>
      const chat = document.getElementById("chat");
      const queryInput = document.getElementById("query");
      const sendBtn = document.getElementById("send");
      const clearBtn = document.getElementById("clear");
      const footer = document.getElementById("footer");
      const greeting = document.getElementById("greeting");

      const currentUser = {{ (username or "")|tojson }};

      let currentBotMsg = null; // ÂΩìÂâçÊú∫Âô®‰∫∫Ê∂àÊÅØÂÆπÂô®
      let isRequesting = false; // ËØ∑Ê±ÇÁä∂ÊÄÅÊ†áËÆ∞ÔºåÈò≤Ê≠¢ÈáçÂ§çËØ∑Ê±Ç
      let currentController = null; // ÂΩìÂâçËØ∑Ê±ÇÁöÑ AbortController

      // Êõ¥Êñ∞Â∏ÉÂ±ÄÁä∂ÊÄÅ
      function updateLayout() {
        // ÈáçÊñ∞Ëé∑ÂèñÈóÆÂÄôËØ≠ÂÖÉÁ¥†ÔºàÂèØËÉΩÂú®Ê∏ÖÁ©∫ÂêéÈáçÊñ∞ÂàõÂª∫Ôºâ
        const greetingElement = document.getElementById("greeting");

        // Ê£ÄÊü•ÊòØÂê¶ÊúâÂÆûÈôÖÁöÑÊ∂àÊÅØÔºàÊéíÈô§ÈóÆÂÄôËØ≠Ôºâ
        const bubbles = Array.from(chat.children).filter(
          child => !child.classList.contains("greeting")
        );
        const hasMessages = bubbles.length > 0;

        if (hasMessages) {
          // ÊúâÊ∂àÊÅØÊó∂ÔºöÁßªÈô§ empty Á±ªÔºåÈöêËóèÈóÆÂÄôËØ≠ÔºåËæìÂÖ•Ê°Ü‰∏ãÁßª
          chat.classList.remove("empty");
          if (greetingElement) greetingElement.style.display = "none";
          footer.classList.remove("centered");
        } else {
          // Ê≤°ÊúâÊ∂àÊÅØÊó∂ÔºöÊ∑ªÂä† empty Á±ªÔºåÊòæÁ§∫ÈóÆÂÄôËØ≠ÔºåËæìÂÖ•Ê°ÜÂ±Ö‰∏≠
          chat.classList.add("empty");
          if (greetingElement) greetingElement.style.display = "block";
          footer.classList.add("centered");
        }
      }

      // Ê∑ªÂä†ËÅäÂ§©Ê∞îÊ≥°
      function appendBubble(text, role) {
        const div = document.createElement("div");
        div.className = `bubble ${role}`;
        div.innerText = text;
        chat.appendChild(div);
        chat.scrollTop = chat.scrollHeight;
        updateLayout();
        return div;
      }

      // ÈáçÁΩÆËØ∑Ê±ÇÁä∂ÊÄÅ
      function resetRequestState() {
        isRequesting = false;
        queryInput.disabled = false;
        currentController = null;
        // Ëá™Âä®ËÅöÁÑ¶ËæìÂÖ•Ê°Ü
        queryInput.focus();
      }

      // ÂèëÈÄÅËØ∑Ê±ÇÔºà‰∏ÄÊ¨°ÊÄßÂìçÂ∫îÔºâ
      async function sendQuery() {
        const query = queryInput.value.trim();
        if (!query) return;

        // Èò≤Ê≠¢ÈáçÂ§çËØ∑Ê±Ç
        if (isRequesting) {
          console.warn("[WARN] ËØ∑Ê±ÇÊ≠£Âú®ËøõË°å‰∏≠ÔºåËØ∑ÂãøÈáçÂ§çÂèëÈÄÅ");
          return;
        }

        // ÂèñÊ∂à‰πãÂâçÁöÑËØ∑Ê±ÇÔºàÂ¶ÇÊûúÊúâÔºâ
        if (currentController) {
          currentController.abort();
        }

        // ËÆæÁΩÆËØ∑Ê±ÇÁä∂ÊÄÅ
        isRequesting = true;
        queryInput.disabled = true;

        // ÂàõÂª∫Êñ∞ÁöÑ AbortController
        currentController = new AbortController();

        appendBubble(query, "user");
        currentBotMsg = appendBubble("ÊÄùËÄÉ‰∏≠...", "bot");

        // ‚úÖ ÊèêÈóÆÂêéËá™Âä®Ê∏ÖÁ©∫ËæìÂÖ•Ê°Ü
        queryInput.value = "";

        // ÊûÑÂª∫ËØ∑Ê±Ç URL
        const params = new URLSearchParams({ query });
        if (currentUser) {
          params.append("user", currentUser);
        }

        const url = `/ask?${params.toString()}`;

        try {
          // ÂèëÈÄÅ fetch ËØ∑Ê±Ç
          const response = await fetch(url, {
            signal: currentController.signal,
            method: "GET",
            headers: {
              "Accept": "application/json",
            },
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const data = await response.json();

          // Â§ÑÁêÜÂìçÂ∫î
          if (data.success && data.answer) {
            // ÊòæÁ§∫ÂÆåÊï¥Á≠îÊ°à
            currentBotMsg.textContent = data.answer;
            chat.scrollTop = chat.scrollHeight;
            console.log("[SUCCESS] Êî∂Âà∞ÂÆåÊï¥Á≠îÊ°àÔºåÈïøÂ∫¶:", data.answer.length);
          } else {
            // ÊòæÁ§∫ÈîôËØØ‰ø°ÊÅØ
            const errorMsg = data.error || "Êó†Ê≥ïÁîüÊàêÁ≠îÊ°à";
            currentBotMsg.textContent = `ÈîôËØØ: ${errorMsg}`;
            console.error("[ERROR] ÁîüÊàêÁ≠îÊ°àÂ§±Ë¥•:", errorMsg);
          }
        } catch (error) {
          // Â§ÑÁêÜÈîôËØØ
          if (error.name === "AbortError") {
            console.log("[INFO] ËØ∑Ê±ÇÂ∑≤ÂèñÊ∂à");
            currentBotMsg.textContent = "ËØ∑Ê±ÇÂ∑≤ÂèñÊ∂à";
          } else {
            console.error("[ERROR] ËØ∑Ê±ÇÂ§±Ë¥•:", error);
            currentBotMsg.textContent = `ËØ∑Ê±ÇÂ§±Ë¥•: ${error.message}`;
          }
        } finally {
          // ÈáçÁΩÆËØ∑Ê±ÇÁä∂ÊÄÅ
          resetRequestState();
        }
      }

      // Ê∏ÖÁ©∫ËÅäÂ§©ËÆ∞ÂΩï
      function clearChat() {
        // Ê∏ÖÁ©∫ÊâÄÊúâÊ∂àÊÅØÔºåÈáçÊñ∞ÂàõÂª∫ÈóÆÂÄôËØ≠
        chat.innerHTML = "";
        const greetingDiv = document.createElement("div");
        greetingDiv.className = "greeting";
        greetingDiv.id = "greeting";
        greetingDiv.textContent = "‰Ω†Â•ΩÔºÅ";
        chat.appendChild(greetingDiv);
        updateLayout();
        queryInput.focus();
      }

      // ÂõûËΩ¶ÈîÆÂèëÈÄÅ
      queryInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey && !isRequesting) {
          e.preventDefault();
          sendQuery();
        }
      });

      // ÂàùÂßãÂåñÂ∏ÉÂ±Ä
      updateLayout();

      // È°µÈù¢Âä†ËΩΩÊó∂Ëá™Âä®ËÅöÁÑ¶ËæìÂÖ•Ê°Ü
      queryInput.focus();

      // È°µÈù¢ÂÖ≥Èó≠Êó∂ÂèñÊ∂àËØ∑Ê±Ç
      window.addEventListener("beforeunload", () => {
        if (currentController) {
          currentController.abort();
        }
      });

      // ÁÇπÂáªËÅäÂ§©Âå∫ÂüüÊó∂ËÅöÁÑ¶ËæìÂÖ•Ê°Ü
      chat.addEventListener("click", () => {
        queryInput.focus();
      });
    </script>
  </body>
</html>
